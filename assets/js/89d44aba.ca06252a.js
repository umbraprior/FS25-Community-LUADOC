"use strict";(globalThis.webpackChunkfs25_community_luadoc=globalThis.webpackChunkfs25_community_luadoc||[]).push([[98792],{28453(e,n,t){t.d(n,{R:()=>o,x:()=>l});var r=t(96540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}},63171(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"script/Networking/PlayerServerNetworkComponent","title":"PlayerServerNetworkComponent","description":"PlayerServerNetworkComponent","source":"@site/../docs/script/Networking/PlayerServerNetworkComponent.md","sourceDirName":"script/Networking","slug":"/script/Networking/PlayerServerNetworkComponent","permalink":"/FS25-Community-LUADOC/script/Networking/PlayerServerNetworkComponent","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1767161192000,"frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"PlayerRemoteNetworkComponent","permalink":"/FS25-Community-LUADOC/script/Networking/PlayerRemoteNetworkComponent"},"next":{"title":"AnimatedMapObject","permalink":"/FS25-Community-LUADOC/script/Objects/AnimatedMapObject"}}');var s=t(74848),i=t(28453);const o={},l=void 0,a={},d=[{value:"PlayerServerNetworkComponent",id:"playerservernetworkcomponent",level:2},{value:"new",id:"new",level:3},{value:"readUpdateStream",id:"readupdatestream",level:3},{value:"update",id:"update",level:3},{value:"updateTick",id:"updatetick",level:3},{value:"writeUpdateStream",id:"writeupdatestream",level:3}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"playerservernetworkcomponent",children:"PlayerServerNetworkComponent"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Description"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"The class which handles player positions and states on the server side."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Parent"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"?version=script&category=61&class=572",children:"PlayerNetworkComponent"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Functions"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#new",children:"new"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#readupdatestream",children:"readUpdateStream"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#update",children:"update"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#updatetick",children:"updateTick"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#writeupdatestream",children:"writeUpdateStream"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"new",children:"new"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Description"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Creates a new network component for the given player."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Definition"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"new(Player player)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Arguments"})}),"\n\n\n\n\n\n\n\n\n",(0,s.jsx)(n.table,{children:(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Player"}),(0,s.jsx)(n.th,{children:"player"}),(0,s.jsx)(n.th,{children:"The player whose position and state is being managed by this component."})]})})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Return Values"})}),"\n\n\n\n\n\n\n\n\n",(0,s.jsx)(n.table,{children:(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Player"}),(0,s.jsx)(n.th,{children:"instance"}),(0,s.jsx)(n.th,{children:"The created instance."})]})})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Code"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-lua",children:"function PlayerServerNetworkComponent.new(player)\n    local self = PlayerNetworkComponent.new(player, PlayerServerNetworkComponent _mt)\n\n    self.player = player\n\n    -- The owner player has extra debug information drawn.\n    if not player.isOwner then\n        self.tickHistory = { }\n\n        -- The next tick to send to the client.\n        self.nextSendTick = 0\n    end\n\n    self.skipModel = false\n    self.skipMover = false\n    self.isFirstPerson = false\n\n    return self\nend\n\n"})}),"\n",(0,s.jsx)(n.h3,{id:"readupdatestream",children:"readUpdateStream"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Description"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Reads the data from the incoming network stream and handles the state."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Definition"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"readUpdateStream(integer streamId, Connection connection, integer timestamp)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Arguments"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"integer"}),(0,s.jsx)(n.th,{children:"streamId"}),(0,s.jsx)(n.th,{children:"The id of the stream from which to read."})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Connection"}),(0,s.jsx)(n.td,{children:"connection"}),(0,s.jsx)(n.td,{children:"The connection between the server and the target client."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"integer"}),(0,s.jsx)(n.td,{children:"timestamp"}),(0,s.jsx)(n.td,{children:"The current timestamp for synchronisation purposes."})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Code"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-lua",children:"function PlayerServerNetworkComponent:readUpdateStream(streamId, connection, timestamp)\n\n    PlayerServerNetworkComponent:superClass().readUpdateStream( self , streamId, connection, timestamp)\n\n    -- If the player is locally hosting the server, don't bother reading the update stream for them.\n        if self.player.isOwner then\n            return\n        end\n\n        local tickIndex = streamReadUInt32(streamId)\n\n        -- Read the movement.\n        local movementX = streamReadFloat32(streamId)\n        local movementY = streamReadFloat32(streamId)\n        local movementZ = streamReadFloat32(streamId)\n        local movementYaw = NetworkUtil.readCompressedAngle(streamId)\n        self.isFirstPerson = streamReadBool(streamId)\n        local isCrouching = streamReadBool(streamId)\n\n        -- Enqueue the movement within the blessed physics system.\n        self.player.capsuleController:move(movementX, movementY, movementZ)\n        self.player.mover:setMovementYaw(movementYaw)\n        self.player.mover:setIsCrouching(isCrouching)\n\n        local interpolator = self.player.positionalInterpolator\n        interpolator:startNetworkNewPhase()\n        interpolator:setTargetYaw(movementYaw)\n\n        local physicsIndex = getPhysicsUpdateIndex()\n        table.insert( self.tickHistory, { index = tickIndex, physicsIndex = physicsIndex } )\n\n        interpolator:setTargetPhysicsIndex(physicsIndex)\n        --\n        -- local maximumSpeed = self.player.stateMachine.states.onFoot:getMaximumSpeed()\n        -- local speedPercentage = NetworkUtil.readCompressedPercentages(streamId, 12)\n        -- local verticalSpeed = NetworkUtil.readCompressedRange(streamId, PlayerMover.MAXIMUM_DOWNWARD_SPEED, PlayerMover.MAXIMUM_UPWARD_SPEED, 12)\n\n        -- local movementDirectionX, movementDirectionZ = 0, 0\n        -- if movementX ~ = 0 or movementZ ~ = 0 then\n            -- movementDirectionX, movementDirectionZ = MathUtil.vector2Normalize(movementX, movementZ)\n            -- end\n\n            -- local currentPositionX, currentPositionY, currentPositionZ = self.player:getPosition()\n            -- self.player.positionalInterpolator:startNetworkPhaseWithTarget(currentPositionX, currentPositionY, currentPositionZ, qx, qy, qz, qw)\n\n            -- self.player.positionalInterpolator:setDirection(movementDirectionX, movementDirectionZ)\n\n            -- self.player.mover:setMovementYaw(movementYaw)\n            -- self.player.mover:setVelocity(movementDirectionX * maximumSpeed * speedPercentage, verticalSpeed, movementDirectionZ * maximumSpeed * speedPercentage)\n            -- self.player.mover:setSpeed(maximumSpeed * speedPercentage)\n\n        end\n\n"})}),"\n",(0,s.jsx)(n.h3,{id:"update",children:"update"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Description"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Updates the player based on the network state every frame."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Definition"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"update(float dt)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Arguments"})}),"\n\n\n\n\n\n\n\n\n",(0,s.jsx)(n.table,{children:(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"float"}),(0,s.jsx)(n.th,{children:"dt"}),(0,s.jsx)(n.th,{children:"delta time in ms"})]})})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Code"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-lua",children:"function PlayerServerNetworkComponent:update(dt)\n\nend\n\n"})}),"\n",(0,s.jsx)(n.h3,{id:"updatetick",children:"updateTick"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Description"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Runs every tick (around 30 times a second) and handles preparing the state."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Definition"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"updateTick(float dt)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Arguments"})}),"\n\n\n\n\n\n\n\n\n",(0,s.jsx)(n.table,{children:(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"float"}),(0,s.jsx)(n.th,{children:"dt"}),(0,s.jsx)(n.th,{children:"Delta time in ms."})]})})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Code"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-lua",children:"function PlayerServerNetworkComponent:updateTick(dt)\n\n    -- Pump through the simulating ticks to remove any that have been simulated, and set the index of the tick to send.\n    if not self.player.isOwner then\n\n        -- find the latest index, which is already simulated now\n        local latestSimulatedIndex = - 1\n        local history = self.tickHistory[ 1 ]\n        while history ~ = nil and getIsPhysicsUpdateIndexSimulated(history.physicsIndex) do\n            latestSimulatedIndex = history.index\n            table.remove( self.tickHistory, 1 )\n            history = self.tickHistory[ 1 ]\n        end\n\n        if latestSimulatedIndex > = 0 then\n            self.nextSendTick = latestSimulatedIndex\n            self.player:raiseDefaultDirtyFlag()\n        end\n    end\n\n    self.doNextDebugDrawTick = true\nend\n\n"})}),"\n",(0,s.jsx)(n.h3,{id:"writeupdatestream",children:"writeUpdateStream"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Description"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Writes the state into the outgoing network stream."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Definition"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"writeUpdateStream(integer streamId, Connection connection, integer dirtyMask)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Arguments"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"integer"}),(0,s.jsx)(n.th,{children:"streamId"}),(0,s.jsx)(n.th,{children:"The id of the stream into which to write."})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Connection"}),(0,s.jsx)(n.td,{children:"connection"}),(0,s.jsx)(n.td,{children:"The connection between the server and the target client."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"integer"}),(0,s.jsx)(n.td,{children:"dirtyMask"}),(0,s.jsx)(n.td,{children:"The current dirty mask."})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Code"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-lua",children:"function PlayerServerNetworkComponent:writeUpdateStream(streamId, connection, dirtyMask)\n\n    PlayerServerNetworkComponent:superClass().writeUpdateStream( self , streamId, connection, dirtyMask)\n\n    -- The client who is controlling this player needs special tick data.\n    local isTargetPlayer = connection = = self.player.connection\n    if isTargetPlayer then\n        -- Write the tick.\n        streamWriteUInt32(streamId, self.nextSendTick)\n    end\n\n    streamWriteBool(streamId, self.player.isControlled)\n    streamWriteBool(streamId, self.skipModel)\n    streamWriteBool(streamId, self.skipMover)\n\n    -- Get the position of the player from the last physics update.\n    local positionX, positionY, positionZ = self.player.mover:getPosition()\n    streamWriteFloat32(streamId, positionX)\n    streamWriteFloat32(streamId, positionY)\n    streamWriteFloat32(streamId, positionZ)\n\n    if not isTargetPlayer then\n        -- The target player's client tells the server what yaw they have, the server then tells all other clients.The target player does not need to know its own yaw.\n        local yaw = self.player.mover:getMovementYaw()\n        NetworkUtil.writeCompressedAngle(streamId, yaw)\n\n        -- Get the collision of the player's collider, if the bottom is touching something then they are grounded.\n            local isGrounded = self.player.capsuleController:calculateIfBottomTouchesGround()\n            streamWriteBool(streamId, isGrounded)\n\n            if self.player.isOwner then\n                streamWriteBool(streamId, self.player.camera.isFirstPerson)\n            else\n                    streamWriteBool(streamId, self.isFirstPerson)\n                end\n                streamWriteBool(streamId, self.player.mover.isCrouching)\n                streamWriteBool(streamId, self.player.graphicsComponent.isGraphicsRootNodeVisible)\n            end\n        end\n\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);